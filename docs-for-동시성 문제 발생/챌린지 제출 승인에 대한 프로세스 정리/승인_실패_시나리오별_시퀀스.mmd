sequenceDiagram
    autonumber
    participant CL as concurrency-lab
    participant CL_DB as concurrency-lab DB
    participant Shop as shop-api
    participant Shop_DB as shop-api DB

    Note over CL, Shop_DB: 시나리오 A: 정상 성공

    rect rgb(235, 255, 235)
        CL->>Shop: POST /orders
        Shop->>Shop_DB: 재고 차감 + 주문 생성
        Shop-->>CL: 200 OK (orderId=42)
        CL->>CL_DB: order_id=42, status=APPROVED
        CL->>CL_DB: COMMIT
        Note over CL_DB, Shop_DB: concurrency-lab: APPROVED + orderId=42<br/>shop-api: 주문 42 존재, 재고 차감<br/>→ ✅ 정합
    end

    Note over CL, Shop_DB: 시나리오 B: 주문 실패 (shop-api 에러)

    rect rgb(255, 220, 220)
        CL->>Shop: POST /orders
        Shop--xCL: 500 에러 / 재고 부족
        Note right of CL: catch 블록 진입
        CL->>CL_DB: status=APPROVED (order_id=NULL)
        CL->>CL_DB: COMMIT
        Note over CL_DB, Shop_DB: concurrency-lab: APPROVED, order_id=NULL<br/>shop-api: 주문 없음, 재고 그대로<br/>→ ❌ 승인됐는데 보상 없음
    end

    Note over CL, Shop_DB: 시나리오 C: 주문 성공 후 커밋 실패

    rect rgb(255, 220, 220)
        CL->>Shop: POST /orders
        Shop->>Shop_DB: 재고 차감 + 주문 생성 (orderId=42)
        Shop-->>CL: 200 OK
        CL->>CL_DB: order_id=42, status=APPROVED
        CL->>CL_DB: COMMIT 실패 (DB 연결 끊김)
        Note right of CL: 로컬 트랜잭션 롤백
        Note over CL_DB, Shop_DB: concurrency-lab: 여전히 SUBMITTED (롤백)<br/>shop-api: 주문 42 존재, 재고 차감됨<br/>→ ❌ 유령 주문 (주인 없는 주문)
    end

    Note over CL, Shop_DB: 시나리오 D: 응답 유실 (네트워크)

    rect rgb(255, 220, 220)
        CL->>Shop: POST /orders
        Shop->>Shop_DB: 재고 차감 + 주문 생성 (orderId=42)
        Shop--xCL: 응답 전송 중 네트워크 끊김
        Note right of CL: 타임아웃 → catch 블록
        CL->>CL_DB: status=APPROVED (order_id=NULL)
        CL->>CL_DB: COMMIT
        Note over CL_DB, Shop_DB: concurrency-lab: APPROVED, order_id=NULL<br/>shop-api: 주문 42 존재, 재고 차감됨<br/>→ ❌ 유령 주문 + 빈 승인 (최악)
    end
