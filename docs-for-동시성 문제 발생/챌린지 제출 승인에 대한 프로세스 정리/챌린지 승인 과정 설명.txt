================================================================================
  챌린지 제출 승인 프로세스 설명
================================================================================

[전체 흐름 요약]

  참가신청(APPLIED) → 제출(SUBMITTED) → 승인(APPROVED) + 주문생성
                                       → 반려(REJECTED)

  - 참가자가 챌린지에 신청하고, 결과물 URL을 제출하면 관리자가 승인/반려
  - 승인 시 외부 쇼핑몰(shop-api)에 보상 상품 주문이 자동 생성됨

================================================================================

[Mermaid 시퀀스 다이어그램] - 아래 .mmd 파일 참고

  파일: 챌린지_승인_시퀀스.mmd
  파일: 챌린지_상태_전이.mmd

================================================================================

[1단계: 참가 신청 - APPLIED]

  사용자 → POST /api/participations
  ┌──────────────────────────────────────────────┐
  │ ParticipationService.apply()                 │
  │                                              │
  │ 1. 챌린지 존재 확인                          │
  │ 2. participation INSERT (status = APPLIED)   │
  │ 3. 트랜잭션 커밋                             │
  └──────────────────────────────────────────────┘
  결과: participation 테이블에 APPLIED 상태 행 생성

================================================================================

[2단계: 결과물 제출 - SUBMITTED]

  사용자 → PUT /api/participations/{id}/submit
  ┌──────────────────────────────────────────────┐
  │ ParticipationService.submit()                │
  │                                              │
  │ 1. participation 조회                        │
  │ 2. 상태 검증 (APPLIED인지 확인)              │
  │ 3. submission_url, submitted_at 업데이트     │
  │    + status → SUBMITTED 변경                 │
  │ 4. 트랜잭션 커밋                             │
  └──────────────────────────────────────────────┘
  결과: status = SUBMITTED, submission_url 저장

================================================================================

[3단계: 승인 - APPROVED + shop-api 주문 생성]  ★ 핵심 ★

  관리자 → PUT /api/participations/{id}/approve
  ┌──────────────────────────────────────────────────────────────────┐
  │ ParticipationService.approve()  (@Transactional)                │
  │                                                                 │
  │ 1. participation 조회                                           │
  │ 2. 상태 검증 (SUBMITTED인지 확인)                               │
  │ 3. 챌린지 조회 → rewardProductId 획득                           │
  │                                                                 │
  │ 4. ★ shop-api HTTP 호출 (서버 간 통신) ★                        │
  │    │                                                            │
  │    │  ShopClient.createOrder(productId, userId, quantity=1)     │
  │    │  → POST http://localhost:3000/api/orders                   │
  │    │                                                            │
  │    ├─ 성공 시:                                                  │
  │    │   - 응답에서 order.id 추출                                 │
  │    │   - participation.order_id = order.id 저장                 │
  │    │   - participation.status = APPROVED 변경                   │
  │    │                                                            │
  │    └─ 실패 시 (catch):                                          │
  │        - 에러 로그 출력                                         │
  │        - participation.status = APPROVED 변경 (주문 없이!)      │
  │        - order_id = NULL 상태로 남음                            │
  │        → ★ 정합성 불일치: 승인은 됐는데 보상 주문이 없음 ★     │
  │                                                                 │
  │ 5. 트랜잭션 커밋                                                │
  └──────────────────────────────────────────────────────────────────┘

  shop-api 측 처리 (OrderService.create):
  ┌──────────────────────────────────────────────┐
  │ 1. 상품 조회 (product 테이블)                │
  │ 2. 재고 확인 (stock >= quantity)             │
  │ 3. 재고 차감 (stock - quantity)              │
  │ 4. 주문 INSERT (status = PAID)               │
  │ 5. 생성된 주문 정보 반환                     │
  └──────────────────────────────────────────────┘

================================================================================

[3-B단계: 반려 - REJECTED]

  관리자 → PUT /api/participations/{id}/reject
  ┌──────────────────────────────────────────────┐
  │ ParticipationService.reject()                │
  │                                              │
  │ 1. participation 조회                        │
  │ 2. 상태 검증 (SUBMITTED인지 확인)            │
  │ 3. status → REJECTED 변경                    │
  │ 4. 트랜잭션 커밋                             │
  └──────────────────────────────────────────────┘
  결과: 외부 API 호출 없음, 단순 상태 변경

================================================================================

[관련 테이블 정보]

  concurrency-lab DB (PostgreSQL :5434)
  ├── challenge      : 챌린지 정의 (rewardProductId로 shop-api 상품 참조)
  ├── participation  : 참가/제출/승인 이력 (orderId로 shop-api 주문 참조)
  └── member         : 사용자 정보

  shop-api DB (PostgreSQL :5435)
  ├── product        : 보상 상품 (재고 관리)
  └── shop_order     : 주문 (보상 수여 기록)

  두 DB는 완전히 분리되어 있으며, HTTP 통신으로만 연결됨

================================================================================

[핵심 포인트]

  1. approve()는 로컬 트랜잭션(@Transactional) 안에서 외부 HTTP를 호출한다
  2. shop-api의 트랜잭션은 concurrency-lab의 트랜잭션과 독립적이다
  3. catch 블록에서 주문 실패해도 APPROVED로 처리하므로 정합성이 깨질 수 있다
  4. shop-api의 재고 차감에 동시성 제어(락)가 없어 race condition 가능

================================================================================
