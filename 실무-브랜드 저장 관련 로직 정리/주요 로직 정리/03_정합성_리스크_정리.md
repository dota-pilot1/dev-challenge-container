# 03. 정합성 불일치 발생 포인트

## 주요 불일치 시나리오
1. 내부 DB 커밋 전 외부 성공 후 예외
- 외부에는 반영, 내부는 롤백 가능

2. 내부 DB 성공 후 외부 실패
- 내부만 반영되고 외부 미반영

3. 타임아웃 후 실제 외부는 처리 완료
- 호출 측은 실패로 인지하고 재시도하여 중복 가능

4. 동시 요청(같은 brandMid)
- 마지막 요청이 덮어쓰기(Last Write Wins)
- 순서 역전 시 상태 비일관 가능

## 동시성 유발 API
- POST /api/airstar/brands/partner-brands-save
  - 동일 키(예: steId/brandMid) 동시 요청 시 충돌 가능
- 조회 동기화 API(getPlatformBrands, getPartnerBrands)도 배치/수동 호출 동시 실행 시 update 경합 가능

## 최소 방어책
- 비즈니스 키 유니크 제약 + UPSERT 규칙 명확화
- 요청 idempotency key 도입
- 외부 결과 상태 컬럼(예: sync_status, sync_retry_count, sync_error_code) 추가
- 재처리 배치(FAILED/PENDING 대상)
