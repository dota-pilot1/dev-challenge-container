=====================================
재시도 메커니즘 — 관련 파일
=====================================

■ 핵심 파일 (백엔드)

concurrency-lab/.../service/ParticipationService.java
  → approve(): 실패 시 APPROVE_FAILED 상태 저장
  → retryApprove(): APPROVE_FAILED 상태에서만 재시도 허용

concurrency-lab/.../controller/ParticipationController.java
  → PATCH /api/participations/{id}/retry-approve 엔드포인트


■ 승인 이력 (실패 원인 추적용)

concurrency-lab/.../entity/ApprovalHistory.java
  → 승인 이력 엔티티 (action, status, errorMessage, orderId)

concurrency-lab/.../mapper/ApprovalHistoryMapper.java
  → 이력 저장/조회 인터페이스

concurrency-lab/.../resources/mapper/ApprovalHistoryMapper.xml
  → 이력 INSERT/SELECT 쿼리


■ 프론트엔드

devquest-web/src/routes/challenges.tsx
  → APPROVE_FAILED 상태일 때 "재시도" / "더블 재시도" 버튼 표시
  → 실패 시 ConfirmDialog로 에러 상세 표시

devquest-web/src/shared/ui/confirm-dialog.tsx
  → 에러 상세 다이얼로그 컴포넌트

devquest-web/src/shared/lib/parse-error-message.ts
  → JSON 에러 메시지 파싱 유틸


─────────────────────────────────────
■ 핵심 함수 — ParticipationService.java > retryApprove()
─────────────────────────────────────

  @Transactional
  public Participation retryApprove(Long id) {
      Participation participation = participationMapper
          .findByIdForUpdate(id).orElseThrow(...);

      // APPROVE_FAILED 상태에서만 재시도 가능
      if (!"APPROVE_FAILED".equals(participation.getStatus())) {
          throw new CustomException("승인 실패 상태에서만 재시도할 수 있습니다");
      }

      // 동일한 멱등성 키 사용 → 이전 주문이 실제 성공했으면 기존 주문 반환
      String idempotencyKey = "participation-" + id;
      Map<String, Object> order = shopClient.createOrder(..., idempotencyKey, ...);

      // 성공 → APPROVED + 이력(SUCCESS)
      // 실패 → APPROVE_FAILED 유지 + 이력(FAILED + 에러 메시지)
  }

→ approve()와 동일 구조, 상태 검증만 SUBMITTED → APPROVE_FAILED로 다름
→ 이력의 action이 APPROVE_REQUEST → APPROVE_RETRY로 구분됨
