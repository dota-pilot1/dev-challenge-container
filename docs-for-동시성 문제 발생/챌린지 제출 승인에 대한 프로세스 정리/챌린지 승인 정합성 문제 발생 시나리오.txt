================================================================================
  챌린지 승인 시 정합성 문제 발생 시나리오
================================================================================

[현재 코드의 문제 구조]

  approve() 메서드는 하나의 @Transactional 안에서:
    1. concurrency-lab DB 조회/수정  ← 로컬 트랜잭션으로 제어 가능
    2. shop-api HTTP 호출            ← 로컬 트랜잭션과 무관 (별도 DB)

  두 DB가 물리적으로 분리되어 있어 단일 트랜잭션으로 원자성 보장 불가

================================================================================

[시나리오 1] 주문 성공 후 커밋 실패
  - 정합성 결과: shop-api에 주문 존재, concurrency-lab에 승인 없음

  관리자 → approve(id=5)
  ┌─────────────────────────────────────────────────────────┐
  │ 1. participation 조회 → status=SUBMITTED ✓              │
  │ 2. shop-api 주문 요청 → 성공 (order_id=42 생성)   ✓    │
  │ 3. participation.order_id = 42 저장                     │
  │ 4. participation.status = APPROVED 저장                 │
  │ 5. ★ 트랜잭션 커밋 시 DB 연결 끊김 → 롤백 ★            │
  └─────────────────────────────────────────────────────────┘

  concurrency-lab DB: participation 여전히 SUBMITTED (롤백됨)
  shop-api DB:        shop_order id=42 존재 (PAID), stock 이미 차감됨

  → 유령 주문 발생: 보상 상품이 출고됐지만 승인 기록이 없음

================================================================================

[시나리오 2] 주문 실패 시 승인만 저장 (현재 catch 블록 동작)
  - 정합성 결과: 승인은 됐지만 보상 주문이 없음

  관리자 → approve(id=5)
  ┌─────────────────────────────────────────────────────────┐
  │ 1. participation 조회 → status=SUBMITTED ✓              │
  │ 2. shop-api 주문 요청 → ★ 실패 (타임아웃/500에러) ★    │
  │ 3. catch 블록 진입                                      │
  │    - 에러 로그 출력                                     │
  │    - participation.status = APPROVED 저장               │
  │    - order_id = NULL                                    │
  │ 4. 트랜잭션 커밋                                        │
  └─────────────────────────────────────────────────────────┘

  concurrency-lab DB: participation status=APPROVED, order_id=NULL
  shop-api DB:        주문 없음

  → 빈 승인: 챌린지 통과했지만 보상 상품을 받지 못함
  → 관리자가 order_id=NULL인 것을 발견하고 수동 처리해야 함

================================================================================

[시나리오 3] 중복 승인 (동시 요청)
  - 정합성 결과: 한 참가자에게 보상이 2번 지급됨

  관리자A → approve(id=5)       관리자B → approve(id=5)
  ┌───────────────────────┐     ┌───────────────────────┐
  │ 1. 조회: SUBMITTED ✓  │     │ 1. 조회: SUBMITTED ✓  │
  │    (아직 커밋 전)      │     │    (A의 변경 안 보임) │
  │ 2. shop-api 주문 → 43 │     │ 2. shop-api 주문 → 44 │
  │ 3. order_id=43 저장    │     │ 3. order_id=44 저장   │
  │ 4. APPROVED 저장       │     │ 4. APPROVED 저장      │
  │ 5. 커밋 ✓              │     │ 5. 커밋 ✓             │
  └───────────────────────┘     └───────────────────────┘

  concurrency-lab DB: participation status=APPROVED, order_id=44 (B가 덮어씀)
  shop-api DB:        shop_order 43 (PAID) + shop_order 44 (PAID)

  → 이중 지급: 주문 2건, 재고 2번 차감, 하지만 participation에는 44만 기록
  → 주문 43은 미아 주문 (어떤 participation과도 연결 안 됨)

================================================================================

[시나리오 4] shop-api 재고 경합 (Race Condition)
  - 정합성 결과: 재고가 음수가 되거나 실제보다 많이 차감됨

  상품 stock=1 인 상태에서 2명 동시 승인:

  승인A (participation 5)        승인B (participation 7)
  ┌───────────────────────┐     ┌───────────────────────┐
  │ shop-api 주문 요청     │     │ shop-api 주문 요청     │
  │ SELECT stock → 1 ✓    │     │ SELECT stock → 1 ✓    │
  │ stock >= 1 확인 ✓     │     │ stock >= 1 확인 ✓     │
  │ UPDATE stock = 1-1 = 0│     │ UPDATE stock = 1-1 = 0│
  │ INSERT order ✓        │     │ INSERT order ✓        │
  └───────────────────────┘     └───────────────────────┘

  product.stock = 0 (정상이면 하나는 재고 부족 에러여야 함)
  shop_order 2건 생성 (실제 재고는 1개뿐)

  → 초과 판매: 없는 재고를 팔아버림
  → 원인: SELECT → 비교 → UPDATE 사이에 락이 없음

================================================================================

[시나리오 5] 네트워크 불확실성 (응답 유실)
  - 정합성 결과: 주문이 생성됐는지 알 수 없음

  관리자 → approve(id=5)
  ┌─────────────────────────────────────────────────────────┐
  │ 1. shop-api 주문 요청 전송                              │
  │ 2. shop-api가 주문 처리 완료 (order_id=42 생성)         │
  │ 3. ★ 응답 전송 중 네트워크 끊김 ★                      │
  │ 4. concurrency-lab은 타임아웃 → catch 블록 진입         │
  │ 5. 주문 실패로 판단 → APPROVED + order_id=NULL          │
  └─────────────────────────────────────────────────────────┘

  concurrency-lab DB: participation APPROVED, order_id=NULL
  shop-api DB:        shop_order id=42 존재 (PAID), stock 차감 완료

  → 시나리오1과 유사하지만 원인이 다름
  → 재시도하면 주문이 또 생김 (멱등성 없음)
  → orderId로 조회할 방법도 없음 (기록 안 됨)

================================================================================

[테이블 정보 요약]

  ┌─────────────────────────────────────────────────────────┐
  │  concurrency-lab DB (PostgreSQL :5434)                  │
  ├─────────────────────────────────────────────────────────┤
  │                                                         │
  │  [challenge 테이블]                                     │
  │  ┌────────────────────┬──────────────┬───────────────┐  │
  │  │ 컬럼               │ 타입         │ 설명          │  │
  │  ├────────────────────┼──────────────┼───────────────┤  │
  │  │ id                 │ BIGINT PK    │ 챌린지 ID     │  │
  │  │ title              │ VARCHAR      │ 챌린지 제목   │  │
  │  │ description        │ TEXT         │ 설명          │  │
  │  │ reward_product_id  │ INTEGER      │ shop-api 상품 │  │
  │  │ status             │ VARCHAR      │ 상태          │  │
  │  │ created_at         │ TIMESTAMP    │ 생성일시      │  │
  │  │ updated_at         │ TIMESTAMP    │ 수정일시      │  │
  │  └────────────────────┴──────────────┴───────────────┘  │
  │                                                         │
  │  [participation 테이블]                                 │
  │  ┌────────────────────┬──────────────┬───────────────┐  │
  │  │ 컬럼               │ 타입         │ 설명          │  │
  │  ├────────────────────┼──────────────┼───────────────┤  │
  │  │ id                 │ BIGINT PK    │ 참가 ID       │  │
  │  │ challenge_id       │ BIGINT FK    │ 챌린지 참조   │  │
  │  │ user_id            │ BIGINT FK    │ 사용자 참조   │  │
  │  │ status             │ VARCHAR      │ APPLIED /     │  │
  │  │                    │              │ SUBMITTED /   │  │
  │  │                    │              │ APPROVED /    │  │
  │  │                    │              │ REJECTED      │  │
  │  │ submission_url     │ VARCHAR      │ 제출물 URL    │  │
  │  │ submitted_at       │ TIMESTAMP    │ 제출일시      │  │
  │  │ order_id           │ INTEGER      │ shop-api 주문 │  │
  │  │                    │              │ (NULL 가능)   │  │
  │  │ created_at         │ TIMESTAMP    │ 생성일시      │  │
  │  │ updated_at         │ TIMESTAMP    │ 수정일시      │  │
  │  └────────────────────┴──────────────┴───────────────┘  │
  │                                                         │
  │  [member 테이블]                                        │
  │  ┌────────────────────┬──────────────┬───────────────┐  │
  │  │ id                 │ BIGINT PK    │ 회원 ID       │  │
  │  │ email              │ VARCHAR UK   │ 이메일        │  │
  │  │ nickname           │ VARCHAR      │ 닉네임        │  │
  │  │ role               │ VARCHAR      │ ADMIN / USER  │  │
  │  │ created_at         │ TIMESTAMP    │ 생성일시      │  │
  │  │ updated_at         │ TIMESTAMP    │ 수정일시      │  │
  │  └────────────────────┴──────────────┴───────────────┘  │
  └─────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────┐
  │  shop-api DB (PostgreSQL :5435)                         │
  ├─────────────────────────────────────────────────────────┤
  │                                                         │
  │  [product 테이블]                                       │
  │  ┌────────────────────┬──────────────┬───────────────┐  │
  │  │ 컬럼               │ 타입         │ 설명          │  │
  │  ├────────────────────┼──────────────┼───────────────┤  │
  │  │ id                 │ SERIAL PK    │ 상품 ID       │  │
  │  │ name               │ VARCHAR(255) │ 상품명        │  │
  │  │ description        │ TEXT         │ 상품 설명     │  │
  │  │ price              │ NUMERIC(12,2)│ 가격          │  │
  │  │ stock              │ INTEGER      │ 재고 수량     │  │
  │  │ image_url          │ VARCHAR(500) │ 이미지 URL    │  │
  │  │ created_at         │ TIMESTAMP    │ 생성일시      │  │
  │  │ updated_at         │ TIMESTAMP    │ 수정일시      │  │
  │  └────────────────────┴──────────────┴───────────────┘  │
  │                                                         │
  │  [shop_order 테이블]                                    │
  │  ┌────────────────────┬──────────────┬───────────────┐  │
  │  │ 컬럼               │ 타입         │ 설명          │  │
  │  ├────────────────────┼──────────────┼───────────────┤  │
  │  │ id                 │ SERIAL PK    │ 주문 ID       │  │
  │  │ product_id         │ INTEGER      │ 상품 참조     │  │
  │  │ user_id            │ INTEGER      │ 사용자 참조   │  │
  │  │ quantity           │ INTEGER      │ 수량 (기본 1) │  │
  │  │ status             │ ENUM         │ PENDING /     │  │
  │  │                    │              │ PAID /        │  │
  │  │                    │              │ PREPARING /   │  │
  │  │                    │              │ SHIPPED /     │  │
  │  │                    │              │ DELIVERED /   │  │
  │  │                    │              │ CANCELLED     │  │
  │  │ created_at         │ TIMESTAMP    │ 생성일시      │  │
  │  │ updated_at         │ TIMESTAMP    │ 수정일시      │  │
  │  └────────────────────┴──────────────┴───────────────┘  │
  └─────────────────────────────────────────────────────────┘

================================================================================

[테이블 간 관계 (크로스 DB)]

  concurrency-lab DB                    shop-api DB
  ┌──────────────┐                     ┌──────────────┐
  │  challenge   │                     │   product    │
  │              │  reward_product_id  │              │
  │  reward_     │ ─ ─ ─ ─ ─ ─ ─ ─ → │  id          │
  │  product_id  │  (논리적 FK, HTTP)  │  stock       │
  └──────────────┘                     └──────────────┘
                                              │
  ┌──────────────┐                     ┌──────────────┐
  │participation │                     │  shop_order  │
  │              │     order_id        │              │
  │  order_id    │ ─ ─ ─ ─ ─ ─ ─ ─ → │  id          │
  │              │  (논리적 FK, HTTP)  │  product_id  │
  │  user_id     │ ─ ─ ─ ─ ─ ─ ─ ─ → │  user_id     │
  └──────────────┘  (동일 사용자 ID)   └──────────────┘

  ★ DB 간 FK 제약조건 없음 → 정합성은 애플리케이션이 책임져야 함

================================================================================

[문제 요약 매트릭스]

  시나리오          │ concurrency-lab 상태     │ shop-api 상태        │ 불일치 유형
  ─────────────────┼──────────────────────────┼──────────────────────┼──────────────
  1. 커밋 실패      │ SUBMITTED (롤백)         │ 주문 존재 + 재고 차감│ 유령 주문
  2. 주문 실패      │ APPROVED, order_id=NULL  │ 주문 없음            │ 빈 승인
  3. 중복 승인      │ APPROVED, order_id=44    │ 주문 43 + 44 존재    │ 이중 지급
  4. 재고 경합      │ 2건 모두 APPROVED        │ stock=0 (1개뿐)     │ 초과 판매
  5. 응답 유실      │ APPROVED, order_id=NULL  │ 주문 존재 + 재고 차감│ 유령 주문 + 빈 승인

================================================================================
